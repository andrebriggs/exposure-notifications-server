
# File: azure-pipelines.yml
trigger:
- azdo

variables:
  - group: quick-start-vg
  - name: SERVICE
    value: cleanup-export

stages:
  - stage: docker_cleanup_export
    dependsOn: []
    jobs:
    - job: build_push_cleanup_export
      pool:
        vmImage: 'Ubuntu 16.04'
      steps:
      - script: echo $(SERVICE)!
      - script: |
          # Login to Azure 
          echo "az login --service-principal --username $(SP_APP_ID) --password $(SP_PASS) --tenant $(SP_TENANT)"
          az login --service-principal --username "$(SP_APP_ID)" --password "$(SP_PASS)" --tenant "$(SP_TENANT)"
        displayName: 'Azure Login'
      - script: |
          # Docker
          export IMAGE_TAG=$(echo $(Build.BuildNumber) | tr / - | tr . - | tr _ - )
          az acr build -r andrebriggs --image $(SERVICE)-master:$IMAGE_TAG . --build-arg SERVICE=$(SERVICE)
        displayName: 'Docker build'

  - stage: docker_exposure
    dependsOn: []
    jobs:
    - job: build_push_exposure
      pool:
        vmImage: 'Ubuntu 16.04'
      steps:
      - script: echo exposure!
      - script: |
          # Login to Azure 
          echo "az login --service-principal --username $(SP_APP_ID) --password $(SP_PASS) --tenant $(SP_TENANT)"
          az login --service-principal --username "$(SP_APP_ID)" --password "$(SP_PASS)" --tenant "$(SP_TENANT)"
        displayName: 'Azure Login'
      - script: |
          # Docker
          export IMAGE_TAG=$(echo $(Build.BuildNumber) | tr / - | tr . - | tr _ - )
          az acr build -r andrebriggs --image exposure-master:$IMAGE_TAG . --build-arg SERVICE=exposure
        displayName: 'Docker build'